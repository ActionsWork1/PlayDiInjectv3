name: Java Playwright Multi-OS CI

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    name: Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      # ---------- Playwright Cache (Restore) ----------
      - name: Restore Playwright Browsers Cache
        id: pw-cache-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ms-playwright
            %USERPROFILE%\AppData\Local\ms-playwright
            ~/Library/Caches/ms-playwright
          key: playwright-${{ runner.os }}-${{ runner.arch }}-v1

#      # ---------- Install Browsers if Cache Miss ----------
#      - name: Install Playwright Browsers
#        if: steps.pw-cache-restore.outputs.cache-hit != 'true'
#        run: mvn exec:java -Dexec.mainClass=com.microsoft.playwright.CLI -Dexec.args="install chromium --with-deps"

      - name: Install Playwright Browsers (Linux/macOS)
        if: runner.os != 'Windows' && steps.pw-cache-restore.outputs.cache-hit != 'true'
        run: mvn exec:java -Dexec.mainClass=com.microsoft.playwright.CLI -Dexec.args="install chromium"

      - name: Install Playwright Browsers (Windows)
        if: runner.os == 'Windows' && steps.pw-cache-restore.outputs.cache-hit != 'true'
        shell: bash
        run: mvn exec:java -Dexec.mainClass=com.microsoft.playwright.CLI -Dexec.args="install chromium"



      # ---------- Run Tests ----------
      - name: Run Tests (Linux)
        if: runner.os == 'Linux'
        run: xvfb-run --auto-servernum mvn clean test -Denv=ci || true

      - name: Run Tests (Windows/macOS)
        if: runner.os != 'Linux'
        run: mvn clean test -Denv=ci || true

      # ---------- Collect Allure Results ----------
      - name: Collect Allure Results
        if: always()
        shell: bash
        run: |
          mkdir -p allure-results-${{ runner.os }}
          if [ -d "target/allure-results" ]; then
            cp -r target/allure-results/* allure-results-${{ runner.os }}/
          else
            echo "No Allure results found"
          fi

      # ---------- Upload OS-specific results ----------
      - name: Upload Allure Results Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ runner.os }}
          path: allure-results-${{ runner.os }}

      # ---------- Save Playwright Cache ----------
      - name: Save Playwright Browsers Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/ms-playwright
            %USERPROFILE%\AppData\Local\ms-playwright
            ~/Library/Caches/ms-playwright
          key: playwright-${{ runner.os }}-${{ runner.arch }}-v1


  report:
    name: Build & Publish Allure Report
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      # ---------- Download Allure Artifacts ----------
      - name: Download Allure Results
        uses: actions/download-artifact@v4
        with:
          path: merged-allure-results

      # ---------- Merge Results ----------
      - name: Merge Allure Results
        run: |
          mkdir -p allure-results
          cp -r merged-allure-results/*/* allure-results/ || true

      # ---------- Load gh-pages history ----------
      - name: Checkout gh-pages (history)
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Restore Allure History
        run: |
          mkdir -p allure-results/history
          if [ -d "gh-pages/history" ]; then
            cp -r gh-pages/history/* allure-results/history/
          fi

      # ---------- Build Allure Report ----------
      - name: Build Allure Report
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 20

      # ---------- Deploy to GitHub Pages ----------
      - name: Deploy Allure Report
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
#          force_orphan: true   # ⚠️ REMOVE after first successful run
